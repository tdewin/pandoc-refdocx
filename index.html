<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PanDoc Ref Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <script type="module">
        import {
          BlobWriter,
          HttpReader,
          TextReader,
          ZipWriter,
        } from "./zipjs/zip.js/index.js"; //from "https://unpkg.com/@zip.js/zip.js/index.js";
        

        document.getElementById("create-button").addEventListener("click", function() {
            var dlcontainer = document.getElementById("dlcontainer")
            while(dlcontainer.firstChild) {
                dlcontainer.removeChild(dlcontainer.lastChild)
            }
            var t = document.createElement("span")
            t.innerHtml = "Generating ...<br>"
            dlcontainer.appendChild(t)

            getZipFileBlob().then(downloadFile);
        });
            
         async function getZipFileBlob() {
            
            
          const readFile = function (file){
            return new Promise((resolve, reject) => {
                var fr = new FileReader();  
                fr.onload = () => {
                resolve(fr.result )
                };
                fr.onerror = reject;
                fr.readAsText(file);
            });
          }

          const byId = function(id) {
            return document.getElementById(id)
          }
          const idVal = function(id) {
            return byId(id).value
          }


          const zipWriter = new ZipWriter(new BlobWriter());


          

          const flist = [
            "[Content_Types].xml",
            "_rels/.rels",
            "docProps/app.xml",
            "docProps/core.xml",
            "docProps/custom.xml",
            "word/document.xml",
            "word/fontTable.xml",
            "word/footnotes.xml",
            "word/comments.xml",
            "word/numbering.xml",
            "word/settings.xml",
            "word/webSettings.xml",
            "word/_rels/document.xml.rels",
            //"word/_rels/header1.xml.rels",
            //"word/_rels/header2.xml.rels",
            //"word/header1.xml",
            //"word/header2.xml",
            "word/_rels/footnotes.xml.rels",
            "word/theme/theme1.xml",
            "word/styles.xml",
            ]

          const modAfter = ["word/theme/theme1.xml","word/styles.xml","word/document.xml"]

          var parralelFetch = {}
          var promlist = []



          

          const createOrReturnFirst = function (doc,parent,tagname) {
            var multi = parent.getElementsByTagName(tagname)
            if (multi.length > 0) {
                return multi[0]
            } else {
                var e = doc.createElement(tagname)
                parent.appendChild(e)
                return e
            }
          }

          

          for (let index = 0; index < flist.length; index++) {
            const element = flist[index];
            var p = fetch("./src/"+element)
            promlist.push(p)
            parralelFetch[element] = p
            
          }
          Promise.all(promlist)

          promlist = []
          for (let index = 0; index < flist.length; index++) {
            const element = flist[index];
            if (!modAfter.includes(element)) {
                //console.log(element)
                const response = await parralelFetch[element]
                const body = await response.text()

                promlist.push(zipWriter.add(element, new TextReader(body)))
            }

          }

          

          const svgFP = byId("svgFP")
          const f0 = svgFP.files[0]
          const haveFP = (f0 != null)
          if(haveFP) {
            const fpcontent = await readFile(f0)
            promlist.push(zipWriter.add("word/media/image1.svg",new TextReader(fpcontent)));
          }
          
          const svgNP = byId("svgNP")
          const f1 = svgNP.files[0]
          const haveNP = (f1 != null)
          if(haveNP) {
            const fpcontent = await readFile(f1)
            promlist.push(zipWriter.add("word/media/image3.svg",new TextReader(fpcontent)));
          }
          
         

          const parser = new DOMParser();


          //
          // changing theme
          //
          //
          //
          const response = await parralelFetch["word/theme/theme1.xml"]
          const body = await response.text()
          var xmlDoc = parser.parseFromString(body,"text/xml");
          

          let colors = document.getElementsByClassName("themecolor");
          for (let i = 0; i < colors.length; i++) {
            const c = colors[i]
            //console.log(c.id,c.value)


            //<a:srgbClr="http://schemas.openxmlformats.org/drawingml/2006/main" val="1F497D"/>
            var cel = xmlDoc.getElementsByTagName("a:"+c.id)[0]

            var rgbclr = xmlDoc.createElement("a:srgbClr")
            rgbclr.setAttribute("xmlns:a","http://schemas.openxmlformats.org/drawingml/2006/main")
            rgbclr.setAttribute("val",c.value.replace("#",""))
            while (cel.firstChild) {
                cel.removeChild(cel.lastChild);
            }
            cel.appendChild(rgbclr)

            //console.log(cel)
          }

         
          let fonts = ["majorFont","minorFont"].map(n=> document.getElementById(n))
          for (let i = 0; i < fonts.length; i++) {
            const c = fonts[i]
            //console.log(c.id,c.value)

            //console.log(c)
            //<a:majorFont>
            //<a:latin typeface="Calibri" />
            var h = xmlDoc.getElementsByTagName("a:"+c.id)[0]
            var latin = h.getElementsByTagName("a:latin")[0]
            latin.setAttribute("typeface",c.value)

            //console.log(h)
          }
          let allfonts = document.getElementsByClassName("themefont")
          
        
          const themeupd = new XMLSerializer().serializeToString(xmlDoc)
          //console.log(themeupd)
          promlist.push(zipWriter.add("word/theme/theme1.xml",new TextReader(themeupd)));
            
          
          //
          // changing document.xml
          //
          //
          //
          const responseDoc = await parralelFetch["word/document.xml"]
          const bodyDoc = await responseDoc.text()
          var xmlDoc = parser.parseFromString(bodyDoc,"text/xml");

          /* a4
          <w:sectPr w:rsidR="0012706A" w:rsidSect="009B42DC">
            <w:pgSz w:w="11906" w:h="16838"/>
            
            <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440" w:header="720" w:footer="720" w:gutter="0"/>
            <w:cols w:space="720"/>
            <w:docGrid w:linePitch="326"/>
          </w:sectPr>
            us letter
            w:w="12240" w:h="15840"
          */

          var ptm = parseInt(idVal("ptmulti"))

          var docbody = createOrReturnFirst(xmlDoc,xmlDoc,"w:body")
          var sectpr = createOrReturnFirst(xmlDoc,docbody,"w:sectPr")
          var pgsz = createOrReturnFirst(xmlDoc,sectpr,"w:pgSz")

          pgsz.setAttribute("w:w",parseFloat(idVal("docSizeW")*ptm))
          pgsz.setAttribute("w:h",parseFloat(idVal("docSizeH")*ptm))
          pgsz.setAttribute("w:orient",idVal("docSizeO"))


          var pgMar = createOrReturnFirst(xmlDoc,sectpr,"w:pgMar")
          pgMar.setAttribute("w:top",parseFloat(idVal("docSizeMT")*ptm))
          pgMar.setAttribute("w:bottom",parseFloat(idVal("docSizeMB")*ptm))
          pgMar.setAttribute("w:left",parseFloat(idVal("docSizeML")*ptm))
          pgMar.setAttribute("w:right",parseFloat(idVal("docSizeMR")*ptm))
          pgMar.setAttribute("w:header",parseFloat(idVal("docSizeMH")*ptm))
          pgMar.setAttribute("w:footer",parseFloat(idVal("docSizeMF")*ptm))


          const docupd = new XMLSerializer().serializeToString(xmlDoc)
          //console.log(docupd)
          promlist.push(zipWriter.add("word/document.xml",new TextReader(docupd)));

          //
          // changing styles.xml
          //
          //
          //

          const responseSt = await parralelFetch["word/styles.xml"]
          const bodySt = await responseSt.text()
          var xmlDoc = parser.parseFromString(bodySt,"text/xml");

          
          let styles = xmlDoc.getElementsByTagName("w:style")

          let allstyles = {}
          for(let i = 0;i <styles.length;i++) {
                const s = styles[i]
                allstyles[s.getAttribute("w:styleId")] = s
          }
        
          if (allstyles["Title"] && document.getElementById("titlebeforeUpdate").checked) {
            var ppr = createOrReturnFirst(xmlDoc,allstyles["Title"],"w:pPr")
            var spacing = createOrReturnFirst(xmlDoc,ppr,"w:spacing")
            spacing.setAttribute("w:before",parseInt(document.getElementById("titlebefore").value)*ptm)
          }


          const pageBreakBefore = function(style,toggle) {
            if(allstyles[style] && document.getElementById(toggle).checked ) {
                var ppr = createOrReturnFirst(xmlDoc,allstyles[style],"w:pPr")
                createOrReturnFirst(xmlDoc,ppr,"w:pageBreakBefore")
            }
          } 
          pageBreakBefore("TOCHeading","tocpagebreakUpdate")
          pageBreakBefore("Heading1","h1pagebreakUpdate")
          pageBreakBefore("AbstractTitle","abstractpagebreakUpdate")
        

          let headings = [1,2,3,4,5,6,7,8,9].map((v)=> "Heading"+v)
          headings.push("BodyText","Author","Title","Subtitle","Date","VerbatimChar","Abstract","AbstractTitle","TOCHeading","Hyperlink")

          headings.forEach(h=> {
            //1 is minorfont, 2 is majorfont for headings
            var bf = fonts[1].value
            if (h.length > 7 && h.substring(0,7) == "Heading") {
                bf = fonts[0].value
            }


             var style = allstyles[h]
             
             if (style != null) {
                var rpr = createOrReturnFirst(xmlDoc,style,"w:rPr")
                var ppr = createOrReturnFirst(xmlDoc,style,"w:pPr")
                
                var rm = ["w:color","w:sz","w:szCs","w:b","w:bCs","w:i","w:iCs","w:u"]
                rm.forEach((r)=>{
                    var q = rpr.getElementsByTagName(r)
                    if (q.length > 0) {
                        rpr.removeChild(q[0])
                    }
                })
                //<w:color w:val="4F81BD" w:themeColor="accent1" />
                //<w:sz w:val="24" />
                //<w:szCs w:val="24" />
                //<w:b />
                //<w:bCs />
                //<w:i />
                //<w:iCs />

                var selcolor = document.getElementById(h+"color").value
                if(!document.getElementById("fontburnin").checked) {
                  var color = xmlDoc.createElement("w:color")
                  color.setAttribute("w:themeColor",selcolor)
                  rpr.appendChild(color)
                } else {
                  var color = xmlDoc.createElement("w:color")
                  var val = "333333"
                  for (let i = 0; i < colors.length; i++) {
                    const c = colors[i]
                    if (c.id == selcolor) {
                      val = c.value.replace("#","")
                    }
                  }
                  color.setAttribute("w:val",val)
                  rpr.appendChild(color)
                  console.log(rpr)
                }
                

                //Specifies the font size in half points: <w:sz w:val="28"/>. Note that szCs is used for complex script fonts such as Arabic.
                //http://officeopenxml.com/WPtextFormatting.php
                const hp = document.getElementById(h+"sz").value

                var sz = xmlDoc.createElement("w:sz")
                sz.setAttribute("w:val",hp*2)
                rpr.appendChild(sz)

                var sz = xmlDoc.createElement("w:szCs")
                sz.setAttribute("w:val",hp*2)
                rpr.appendChild(sz)


                const bc = document.getElementById(h+"b").checked
                if (bc) {
                    var b = xmlDoc.createElement("w:b")
                    rpr.appendChild(b)
                    b = xmlDoc.createElement("w:bCs")
                    rpr.appendChild(b)
                }

                const ic = document.getElementById(h+"i").checked
                if (ic) {
                    var i = xmlDoc.createElement("w:i")
                    rpr.appendChild(i)
                    i = xmlDoc.createElement("w:iCs")
                    rpr.appendChild(i)
                }

                const uc = document.getElementById(h+"u").checked
                
                if (uc) {
                    var u = xmlDoc.createElement("w:u")
                    u.setAttribute("w:val","single")
                    
                    rpr.appendChild(u)
                }

                const jc  = document.getElementById(h+"j").value
                if (jc != "default") {
                    var wjc = createOrReturnFirst(xmlDoc,ppr,"w:jc")
                    wjc.setAttribute("w:val",jc)
                }
                
                
                const fbi = (document.getElementById("fontburnin").checked || document.getElementById(h+"font").value != "default" )
                if (fbi) {
                    if (document.getElementById(h+"font").value != "default") {
                        bf = document.getElementById(document.getElementById(h+"font").value).value
                    }

                    var q = rpr.getElementsByTagName("w:rFonts")
                    if (q.length > 0) {
                        rpr.removeChild(q[0])
                    }
                    
                    var f = xmlDoc.createElement("w:rFonts")
                    f.setAttribute("w:ascii",bf)
                    f.setAttribute("w:hAnsi",bf)
                    f.setAttribute("w:cs",bf)
                    f.setAttribute("w:eastAsiaTheme","majorEastAsia")
                    rpr.appendChild(f)

                    

                    //console.log("bbbbbbuuuurn",bf)
                }

                
                //console.log(style)

             } else {
                console.log("not found",h)
             }
          })


          const styleupd = new XMLSerializer().serializeToString(xmlDoc)


          //console.log(styleupd)
          promlist.push(zipWriter.add("word/styles.xml",new TextReader(styleupd)));

          await Promise.all(promlist);
          return zipWriter.close();
        }
        
         function downloadFile(blob) {
            var dlcontainer = document.getElementById("dlcontainer")
            while(dlcontainer.firstChild) {
                dlcontainer.removeChild(dlcontainer.lastChild)
            }
            
            const fname = document.getElementById("filename-input").value.replace("{u}",parseInt((Date.now()/1000)))

            dlcontainer.appendChild(Object.assign(document.createElement("a"), {
                download: fname,
                href: URL.createObjectURL(blob),
                textContent: "Download docx file",
                className: "downloadlink",
            }));

            var howto = document.createElement("div")
            howto.innerHTML = "<br>Usage:<br><pre>echo '---\\ntitle: Test Document\\ndate: 2024\\nauthor: Author\\n---\\n# Title\\n## Sub Title 1 \\nSome content\\n\\n# Title 2\\n## Sub Title 2 \\nSome content' > test.md\npandoc -o mydoc.docx --highlight-style=monochrome --toc=true --toc-depth=3 --reference-doc="+fname+" test.md</pre>"
            dlcontainer.appendChild(howto)
        }

       
            </script>
            <script>
                function byId(id) {
                    return document.getElementById(id)
                }
                function idVal(id,v) {
                    var e = byId(id)
                    if (v !== undefined) {
                        e.value = v
                    }
                    return e.value
                }
                function idValI(id,v) {
                    return parseInt(idVal(id,v))
                }
                function idValF(id,v) {
                    return parseFloat(idVal(id,v))
                }

                function swPt(e) {
                    var m = 20
                    
                    if(idValI("ptmulti") == 20) {
                        m = 1/20
                       
                    } 
                    var l = ["docSizeH","docSizeW","docSizeMB","docSizeMT","docSizeML","docSizeMR","docSizeMH","docSizeMF","titlebefore"]
                    l.forEach(l=>{
                        idValF(l,Math.round(idValF(l)*m,2))
                    })
                }

                //function to switch between portait mode and landscape
                function sw() {
                    var t = idVal("docSizeH")
                    idVal("docSizeH",idVal("docSizeW"))
                    idVal("docSizeW",t)

                    var e = byId("docSizeO")
                    var opts = e.getElementsByTagName("option")
                    if(idVal("docSizeO") == opts[0].value) {
                        opts[1].selected = true
                    } else {
                        opts[0].selected = true
                    }
                }
                function szSel() {
                    var t = idVal("docSizeFormat").split("x")
                    idVal("docSizeH",t[1]/idValI("ptmulti"))
                    idVal("docSizeW",t[0]/idValI("ptmulti"))
                    var e = byId("docSizeO")
                    var opts = e.getElementsByTagName("option")
                    opts[parseInt(t[2])].selected = true
                }

                
                function HSLToHex(h,s,l) {
                    s /= 100;
                    l /= 100;

                    let c = (1 - Math.abs(2 * l - 1)) * s,
                        x = c * (1 - Math.abs((h / 60) % 2 - 1)),
                        m = l - c/2,
                        r = 0,
                        g = 0, 
                        b = 0; 

                    if (0 <= h && h < 60) {
                        r = c; g = x; b = 0;
                    } else if (60 <= h && h < 120) {
                        r = x; g = c; b = 0;
                    } else if (120 <= h && h < 180) {
                        r = 0; g = c; b = x;
                    } else if (180 <= h && h < 240) {
                        r = 0; g = x; b = c;
                    } else if (240 <= h && h < 300) {
                        r = x; g = 0; b = c;
                    } else if (300 <= h && h < 360) {
                        r = c; g = 0; b = x;
                    }
                    // Having obtained RGB, convert channels to hex
                    r = Math.round((r + m) * 255).toString(16);
                    g = Math.round((g + m) * 255).toString(16);
                    b = Math.round((b + m) * 255).toString(16);

                    // Prepend 0s, if necessary
                    if (r.length == 1)
                        r = "0" + r;
                    if (g.length == 1)
                        g = "0" + g;
                    if (b.length == 1)
                        b = "0" + b;

                    return "#" + r + g + b;
                }

                function createNewElement(parent,eltype,attrs) {
                        var el = document.createElement(eltype)
                        for (const [key, value] of Object.entries(attrs)) {
                            el.setAttribute(key,value)
                        }
                        parent.appendChild(el)
                        return el
                }

                const colors = [
                        {x:"dk1",l:"Dark Color 1",h:"#000000"},
                        {x:"lt1",l:"Light Color 1",h:"#ffffff"},
                        {x:"dk2",l:"Dark Color 2",h:"#333333"},
                        {x:"lt2",l:"Light Color 2",h:"#eeeeee"},
                        {x:"accent1",l:"Accent 1",h:HSLToHex((160),80,50)},
                        {x:"accent2",l:"Accent 2",h:HSLToHex((0),80,50)},
                        {x:"accent3",l:"Accent 3",h:HSLToHex((40),80,50)},
                        {x:"accent4",l:"Accent 4",h:HSLToHex((80),80,50)},
                        {x:"accent5",l:"Accent 5",h:HSLToHex((120),80,50)},
                        {x:"accent6",l:"Accent 6",h:HSLToHex((200),80,50)},
                        {x:"hlink",l:"Link",h:HSLToHex((240),80,50)},
                        {x:"folHlink",l:"Follow Link",h:HSLToHex((280),80,50)},
                    ]

                function load() {
                    const rowname = document.getElementById("rowname")

                    

                    colors.forEach(color => {
                        var row = document.createElement("div")
                        row.setAttribute("class","row mt-2")

                        var col = createNewElement(row,"div",{class:"col-sm-2"})
                        var span = createNewElement(col,"span",{class:"form-label"})
                        span.innerHTML = color.l+"&nbsp;"
                  
                        col = createNewElement(row,"div",{class:"col-sm-2"})
                        createNewElement(col,"input",{value:color.h,type:"color",class:"themecolor form-control",id:color.x})

                        document.getElementById("frm").insertBefore(row,rowname)
                    });

                    fonts = [
                        {x:"majorFont",l:"Major Font",h:"Tahoma"},
                        {x:"minorFont",l:"Minor Font",h:"Tahoma"},
                        {x:"BurnFont1",l:"Custom Font 1",h:"Verdana"},
                        {x:"BurnFont2",l:"Custom Font 2",h:"Consolas"},
                        {x:"BurnFont3",l:"Custom Font 3",h:"Cascadia Code"},
                    ]
                    //Font list
                    fonts.forEach(font => {
                        var row = document.createElement("div")
                        row.setAttribute("class","row mt-2")

                        var col = createNewElement(row,"div",{class:"col-sm-2"})
                        var span = createNewElement(col,"span",{class:"form-label"})
                        span.innerHTML = font.l+"&nbsp;"

                        col = createNewElement(row,"div",{class:"col-sm-2"})
                        createNewElement(col,"input",{value:font.h,type:"text",class:"themefont form-control",id:font.x})

                        document.getElementById("frm").insertBefore(row,rowname)
                    });

                    headings = [
                        {x:"BodyText",l:"BodyText",h:{sz:11,color:"dk1",b:false,i:false}},

                        {x:"Title",l:"Title",h:{sz:30,color:"dk1",b:false,i:false,jc:"start"}},
                        {x:"Subtitle",l:"Subtitle",h:{sz:16,color:"dk1",b:false,i:false,jc:"start"}},
                        {x:"Author",l:"Author",h:{sz:11,color:"dk1",b:false,i:false,jc:"start"}},
                        {x:"Date",l:"Date",h:{sz:11,color:"dk1",b:false,i:false,jc:"start"}},
                        
                        {x:"AbstractTitle",l:"AbstractTitle",h:{sz:16,color:"dk1",b:true,i:false,jc:"start"}},
                        {x:"Abstract",l:"Abstract",h:{sz:14,color:"dk1",b:false,i:false,jc:"start"}},
                        
                        {x:"Heading1",l:"Heading 1",h:{sz:45,color:"dk1",b:false,i:false}},
                        {x:"Heading2",l:"Heading 2",h:{sz:36,color:"dk1",b:false,i:false}},
                        {x:"Heading3",l:"Heading 3",h:{sz:23,color:"accent1",b:false,i:false}},
                        {x:"Heading4",l:"Heading 4",h:{sz:20,color:"accent1",b:false,i:false}},
                        {x:"Heading5",l:"Heading 5",h:{sz:16,color:"accent1",b:false,i:false}},
                        {x:"Heading6",l:"Heading 6",h:{sz:13,color:"accent1",b:false,i:false}},
                        {x:"Heading7",l:"Heading 7",h:{sz:13,color:"accent1",b:false,i:false}},
                        {x:"Heading8",l:"Heading 8",h:{sz:12,color:"accent1",b:false,i:false}},
                        {x:"Heading9",l:"Heading 9",h:{sz:12,color:"accent1",b:false,i:false}},
                        {x:"TOCHeading",l:"TOC Heading",h:{sz:45,color:"accent1",b:false,i:false}},

                        {x:"VerbatimChar",l:"VerbatimChar",h:{sz:11,color:"accent1",b:false,i:false,f:"BurnFont2"}},
                        {x:"Hyperlink",l:"Hyperlink",h:{sz:11,color:"accent6",b:false,i:false}},
                    ]

                    headings.forEach(heading=> {
                        var row = document.createElement("div")
                        row.setAttribute("class","row mt-2")

                        var col = createNewElement(row,"div",{class:"col-sm-2"})
                        var span = createNewElement(col,"span",{class:"form-label"})
                        span.innerHTML = heading.l+"&nbsp;"

                        //size
                        col = createNewElement(row,"div",{class:"col-sm-1"})
                        createNewElement(col,"input",{value:heading.h.sz,type:"number",class:"form-control",id:heading.x+"sz"})

                    
                        

                        // Colors
                        col = createNewElement(row,"div",{class:"col-sm-2"})
                        var selcol = createNewElement(col,"select",{class:"form-control",id:heading.x+"color"})
                        
                        colors.forEach(c=> {
                            var opt = createNewElement(selcol,"option",{value:c.x})
                            if (c.x == heading.h.color) {
                                opt.setAttribute("selected",true)
                            }
                            opt.innerText = c.l
                        })

                       

                        // Fonts
                        col = createNewElement(row,"div",{class:"col-sm-2"})
                        var selcol = createNewElement(col,"select",{class:"form-control",id:heading.x+"font"})
                        
                        
                        var opt = createNewElement(selcol,"option",{value:"default",selected:(heading.h.f === undefined)})
                        opt.innerText = "Default"
                       
                        fonts.forEach(f=> {
                            var opt = createNewElement(selcol,"option",{value:f.x})
                            opt.innerText = f.l
                            if (heading.h.f !== undefined && f.x == heading.h.f) {
                                opt.setAttribute("selected",true)
                            }
                        })
   


                        // Justify
                        //http://officeopenxml.com/WPalignment.php
                        col = createNewElement(row,"div",{class:"col-sm-2"})
                        var selcol = createNewElement(col,"select",{class:"form-control",id:heading.x+"j"})
                        
                        const sel = (heading.h.jc)?heading.h.jc:"default"
                        const list = ["default","start","end","center","both","distribute"]
                        
                    
                        list.forEach(f=> {
                            var opt = createNewElement(selcol,"option",{value:f})
                            if(f == sel) {
                                opt.setAttribute("selected",(sel == f))
                            }
                            opt.innerText = f
                        })
 


                        //check bold
                        col = createNewElement(row,"div",{class:"col-sm-1"})
                        var input = createNewElement(col,"input",{value:heading.h.sz,type:"checkbox",class:"form-check-input",id:heading.x+"b"})
                        if (heading.h.b) {
                            input.setAttribute("checked",true)
                        }
                        var span = createNewElement(col,"span",{}); 
                        span.innerHTML = " bold";

                        //check italic
                        col = createNewElement(row,"div",{class:"col-sm-1"})
                        var input = createNewElement(col,"input",{value:heading.h.sz,type:"checkbox",class:"form-check-input",id:heading.x+"i"})
                        if (heading.h.i) {
                            input.setAttribute("checked",true)
                        }
                        var span = createNewElement(col,"span",{}); 
                        span.innerHTML = " italic";


                        //check underline
                        col = createNewElement(row,"div",{class:"col-sm-1"})
                        var input = createNewElement(col,"input",{value:heading.h.sz,type:"checkbox",class:"form-check-input",id:heading.x+"u"})
                        if (heading.h.u) {
                            input.setAttribute("checked",true)
                        }
                        var span = createNewElement(col,"span",{}); 
                        span.innerHTML = " undln";


                        document.getElementById("frm").insertBefore(row,rowname)
                    });
                    
                }
                function dlsvg() {
                    const ptmulti = idVal("ptmulti")
                    const pt20tomm = 0.01763889 // /20 /72 *2,54 *10
                    const pt20w = idValF("docSizeW")*ptmulti
                    const pt20h = idValF("docSizeH")*ptmulti
                    const ac1 = idVal("accent1")
                    const dk1 = idVal("dk1")
                    const szw = Math.round((pt20w*pt20tomm))
                    const szh = Math.round((pt20h*pt20tomm))

                    
                    const mt = Math.round((idValF("docSizeMT")*ptmulti*pt20tomm))
                    const mb = Math.round((idValF("docSizeMB")*ptmulti*pt20tomm))
                    const ml = Math.round((idValF("docSizeML")*ptmulti*pt20tomm))
                    const mr = Math.round((idValF("docSizeMR")*ptmulti*pt20tomm))
                    const mh = Math.round((idValF("docSizeMH")*ptmulti*pt20tomm))
                    const mf = Math.round((idValF("docSizeMF")*ptmulti*pt20tomm))

                    const d = szw/40
                    const r = d/2

                    const colormap = colors.map((c,i) => {
                        return `<circle fill="${c.h}" r="${r}" cx="${-d}" cy="${i*(d+r)+r}"></circle>`
                    }).join("\n")

                    var svg = `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg
   width="${szw}mm"
   height="${szh}mm"
   viewBox="0 0 ${szw} ${szh}"
   version="1.1"
   id="svg1"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
  <defs
     id="defs1" />
  <g
     id="layer1">
    <path
       d="M ${szw},${szh*3.0/5} C ${szw*2.0/3},${szh*4.0/5} ${szw*1.0/3},${szh*4.1/5} 0,${szh*4.0/5} V ${szh}  H ${szw} z"
       style="fill-opacity:0.3;fill:${ac1};stroke-width:0"
       id="bounce" />
    </g>
    <g id="s">
        <g id="colors">
        ${colormap}
        </g>

        <g id="margins">
            <rect id="header" width="${szw}" height="${mf}" x="0" y="0" style="fill: ${ac1};" /> 
            <rect id="header" width="${szw}" height="${mf}" x="0" y="${szh-mf}" style="fill: ${ac1};"  /> 

            <path id="marginleft" d="M ${ml},0 V ${szh}" style="stroke-width: 1;stroke: ${dk1};stroke-opacity: 1mm;" />
            <path id="marginright" d="M ${szw-mr},0 V ${szh}" style="stroke-width: 1;stroke: ${dk1};stroke-opacity: 1mm;" />

            <path id="margintop" d="M 0,${mt} H ${szw}" style="stroke-width: 1;stroke: ${dk1};stroke-opacity: 1mm;" />
            <path id="marginbottom" d="M 0,${szh-mb} H ${szw}" style="stroke-width: 1;stroke: ${dk1};stroke-opacity: 1mm;" />
        </g>
        
    </g>
</svg>`              
                    const file = new Blob([svg], { type: "text/plain" });

                    var element = byId("dwnlink")
                    
                    element.href = URL.createObjectURL(file);
                    element.download = "pandoc-fp.svg";
                    document.body.appendChild(element);

                    element.click()

                }
                function extract() {
                    const c = ["dk1","lt1","dk2","lt2","accent1","accent2","accent3","accent4","accent5","accent6","hlink","folHlink"]
                    const hexcode = /#[0-9a-fA-F]{6}/mg;
                    var proc = document.getElementById("magicarea").value
                    var refresh = []
                    
                    var hexmatch = proc.match(hexcode)
                    if (hexmatch) {
                        hexmatch.forEach((v,i)=>{
                            if (i < c.length) {
                                document.getElementById(c[i]).value = v
                            }
                            
                            refresh.push(v+"  // "+c[i])
                        })
                       
                    }


                    const fonts = ["majorFont","minorFont","BurnFont1","BurnFont2","BurnFont3"]
                    const fontcode = /^font[:] ([^\n]+)$/mg
                    var fontmatch = proc.matchAll(fontcode)

                    if (fontmatch) {
                        var i = 0
                        for (result of fontmatch) {
                            if (i < fonts.length) {
                                document.getElementById(fonts[i++]).value = result[1]
                            }
                            refresh.push(result[0])
                        }
                    }

                    
                    const headingsSZ = /^sz[:] ([A-Za-z0-9]+) ([0-9]+)$/mg
                    var headingmatch = proc.matchAll(headingsSZ)
                    if (headingmatch) {
                        for (result of headingmatch) {
                            document.getElementById(result[1]+"sz").value = result[2]
                            refresh.push(result[0])
                        }
                        
                    }
                    document.getElementById("magicarea").value = refresh.join("\n")
                }
            </script>
</head>
  <body onload="load();">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <div class="container" id="frm" class="form-control">
        <div>
            <h1>Create a reference docx</h1>
            <p>Everything is defined in points. To convert cm to points, multiply with Â±28.3465</p>
            <p>In the magicbox, you can copy random text with hex codes for colors. It will pick up the color in chronological folder. Notice that every run reparses the order
            </p>
        </div>
        
        <div class="row  mt-2">
            <div class="col-sm-3" >
                <span class="form-label">Magic Box</span>
              </div>
              <div class="col-sm-1">
                <input type="button" value="Extract Presets" onclick="extract()" id="magic">
              </div>
        </div>
        <div class="row  mt-2">
            <div class="col-md-12" >
                <textarea id="magicarea" rows="5" class="form-control">some text: color1 #333333 
color 2 #eeeeee
sz: Heading1 55
sz: BodyText 12
font: Verdana
font: Arial
</textarea>
            </div>
        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">PT Multi, multiply values below with 20 (def) or 1</span>
              </div>
              <div class="col-sm-1">
                <select id="ptmulti" onchange="swPt()" class="form-select" >
                    <option value="20" selected>20</option>
                    <option value="1">1</option>
                </select>
              </div>
        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Font burn in</span>
              </div>
              <div class="col-sm-1">
                <input type="checkbox" id="fontburnin" class="form-check-input" checked>
              </div>
        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Title offset from top pt (w:spacing before)</span>
              </div>
              <div class="col-sm-1">
                <input type="checkbox" id="titlebeforeUpdate" class="form-check-input" checked>
              </div>
              <div class="col-sm-1">
                <input type="number" id="titlebefore" class="form-control" value="200">
              </div>
        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Pagebreak for TOC ( w:pageBreakBefore )</span>
              </div>
              <div class="col-sm-1">
                <input type="checkbox" id="tocpagebreakUpdate" class="form-check-input" checked>
              </div>

        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Pagebreak for Abstract ( w:pageBreakBefore )</span>
              </div>
              <div class="col-sm-1">
                <input type="checkbox" id="abstractpagebreakUpdate" class="form-check-input" checked>
              </div>

        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Pagebreak for Heading 1 ( w:pageBreakBefore )</span>
              </div>
              <div class="col-sm-1">
                <input type="checkbox" id="h1pagebreakUpdate" class="form-check-input" checked>
              </div>
        </div>
        
        <!--http://officeopenxml.com/WPsection.php-->
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Doc Size (WxH) pgSz in pt (*20)</span>
              </div>
              <div class="col-sm-1">
                <select id="docSizeFormat" class="form-select" onchange="szSel()">
                    <option value="11906x16838x0" selected>A4</option>
                    <option value="12240x15840x0">US</option>
                </select>
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeW" class="form-control" value="595.3">
              </div>
              <div class="col-sm-1">
                <input type="button" class="btn btn-primary" value="&lt;&gt;" onclick="sw();"/>
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeH" class="form-control" value="841.9">
              </div>
              <div class="col-sm-1">
                <select id="docSizeO" class="form-select" >
                    <option value="portrait" selected>Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>
              </div>
        </div>

        

        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Margin in pt (Top,Bottom,Left,Right) (*20)</span>
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeMT" class="form-control" value="72">
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeMB" class="form-control" value="72">
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeML" class="form-control" value="72">
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeMR" class="form-control" value="72">
              </div>
        </div>
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Header, Footer in pt (Top,Bottom) (*20)</span>
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeMH" class="form-control" value="36">
              </div>
              <div class="col-sm-1">
                <input type="number" id="docSizeMF" class="form-control" value="36">
              </div>
        </div>

        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Download SVG Template</span>
              </div>
              <div class="col-sm-4">
                <input type="button" class="btn btn-primary form-control" value="Download Template" onclick="dlsvg();" />
              </div>
        </div>
        
        <!--
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">First Page SVG</span>
              </div>
              <div class="col-sm-4">
                <input type="file" value="" id="svgFP" class="form-control" >
              </div>
        </div>

        
        <div class="row mt-2" id="rowname">
            <div class="col-sm-4" >
                <span class="form-label">Next Page SVG</span>
              </div>
              <div class="col-sm-4">
                <input type="file" value="" id="svgNP" class="form-control" >
              </div>
        </div>

        -->
        <div class="row mt-2" >
            <div class="col-sm-4" >
                <span class="form-label">Set file name</span>
              </div>
              <div class="col-sm-2">
                <input type="text" id="filename-input" class="form-control" value="reference-{u}.docx">
              </div>
        </div>
        <div class="row mt-2">
            <div class="col-sm-4" >
                <span class="form-label">Create the docx file</span>
              </div>
              <div class="col-sm-2">
                <input type="button" id="create-button" class="btn btn-primary" value="Create" ></input>
              </div>
        </div>
        <div class="mt-2"></div>
        <div class="mt-2 row" id="dlcontainer">

        </div>
        <div class="mt-2 row">
            <p>Made with <a href="https://github.com/gildas-lormeau/">zipfs</a></p>
            <p>Fork me on <a href="https://github.com/tdewin/pandoc-refdocx">github.com/tdewin/pandoc-refdocx</a></p>
        </div>
    </div>   
    
    <a href="" id="dwnlink" style="display: none;">link</a>
    
</body>
</html>
